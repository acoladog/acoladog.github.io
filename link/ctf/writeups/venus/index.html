<!DOCTYPE html>
<html lang="zh-TW"><head><style>body {transition: opacity ease-in 0.2s; } 
body[unresolved] {opacity: 0; display: block; overflow: hidden; position: relative; } 
</style><script type="text/javascript" src="/___vscode_livepreview_injected_script"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writeup Editor - Final Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1f1f1f;
            --card-bg: #16152d;
            --text-color: #e0defb;
            --accent-color: #766DF8;
            --accent-hover: #5a52d6;
            --border-color: #231c6c;
            --code-bg: #1e1e2e;
            --modal-bg: #1a1935;
            --danger-color: #ff5f56;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 100px 0 60px 0;
        }

        #toolbar {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(18, 17, 34, 0.95); backdrop-filter: blur(8px);
            padding: 15px; border-bottom: 2px solid var(--accent-color);
            z-index: 10000; display: flex; gap: 8px; justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6); user-select: none;
            align-items: center;
        }

        #toc-container {
            position: fixed; top: 110px; left: 20px;
            width: 220px; background: var(--card-bg);
            border: 1px solid var(--border-color); border-radius: 12px;
            padding: 15px; max-height: 75vh; overflow-y: auto; z-index: 900;
        }
        #toc-container h4 { margin: 0 0 10px 0; color: var(--accent-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        #toc-list { list-style: none; padding: 0; margin: 0; font-size: 14px; }
        #toc-list li { margin-bottom: 8px; }
        #toc-list .toc-h3 { padding-left: 15px; font-size: 12px; opacity: 0.8; }
        #toc-list a { color: var(--text-color); text-decoration: none; display: block; }
        #toc-list a:hover { color: var(--accent-color); padding-left: 5px; }

        .main-content-wrapper {
            max-width: 800px;
            margin: 0 auto 0 270px;
            padding: 0 30px;
        }

        button { background: #252347; color: white; border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: 0.2s; font-size: 14px; }
        button:hover { background: var(--accent-color); }

        .hl-btn { width: 24px; height: 24px; padding: 0; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); }

        h2 { border-left: 5px solid var(--accent-color); padding-left: 15px; margin-top: 40px; color: white; scroll-margin-top: 120px; }
        h3 { color: var(--accent-color); margin-top: 30px; scroll-margin-top: 120px; }
        #content a { color: var(--accent-color); text-decoration: underline; }
        
        [contenteditable="true"]:focus { outline: none !important; }
        code:focus { outline: none !important; }

        .code-container { 
            line-height: 1.5; position: relative; margin: 25px 0; 
            background: var(--code-bg); border-radius: 8px; border: 1px solid var(--border-color); overflow: visible;
        }
        .lang-badge { position: absolute; top: 0; left: 0; background: var(--border-color); color: var(--accent-color); font-size: 10px; padding: 2px 10px; cursor: pointer; z-index: 10; font-weight: bold; text-transform: uppercase; }
        
        .del-code-btn { position: absolute; top: 8px; right: 45px; width: 20px; height: 20px; background: var(--danger-color); color: white; border-radius: 50%; display: none; justify-content: center; align-items: center; cursor: pointer; z-index: 15; font-size: 12px; border:none; }
        body.editing .del-code-btn { display: flex; }
        
        .del-pop { display: none; position: absolute; top: -35px; right: 40px; background: #2a2a4a; border: 1px solid var(--accent-color); padding: 5px; border-radius: 4px; gap: 5px; z-index: 100; align-items: center; }
        .del-pop button { padding: 2px 8px; font-size: 11px; }

        .copy-btn { position: absolute; top: 10px; right: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; z-index: 5; cursor: pointer; }

        pre[class*="language-"] { margin: 0 !important; padding: 2.5em 1.5em 1.5em !important; font-size: 14px; background: transparent !important; white-space: pre-wrap; word-wrap: break-word; }

        #custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; justify-content: center; align-items: center; }
        .modal-content { background: var(--modal-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--accent-color); width: 320px; }
        .modal-content input { width: 100%; padding: 10px; margin: 10px 0; background: #0f0e22; border: 1px solid var(--border-color); color: white; border-radius: 4px; box-sizing: border-box; }

        .inserted-img { max-width: 100%; border-radius: 10px; margin: 20px 0; border: 2px solid var(--border-color); cursor: pointer; }

        @media (max-width: 1100px) { #toc-container { display: none; } .main-content-wrapper { margin: 0 auto; } }
    </style>

<style>

:root{
	--txt-color:#fff;
}
.coffeecat button {
	margin: 2px;
	border: none !important;
	text-align: center;
	cursor: pointer;
    color: var(--txt-color);
	background: #8bc34a8a !important;
	position: relative;
	transition: all .3s linear;
}
.coffeecat button::before {
	content: "";
	width: 20%;
	height: 20%;
	box-sizing: border-box;
	border-top: 1px solid var(--txt-color);
	border-left: 1px solid var(--txt-color);
	position: absolute;
	top: 0;
	left: 0;
	transition: all .3s linear;
}
.coffeecat button::after {
	content: "";
	width: 20%;
	height: 20%;
	box-sizing: border-box;
	border-bottom: 1px solid var(--txt-color);
	border-right: 1px solid var(--txt-color);
	position: absolute;
	bottom: 0;
	right: 0;
	transition: all .3s linear;
}
.coffeecat button:hover::before, .coffeecat button:hover::after {
	width: 100%;
	height: 100%;
}

</style>
</head>
<body class="" spellcheck="false"><div class="coffeecat" style="font-size: 30px; position: fixed; top: 0px; left: 0px; width: 500px; height: 300px; z-index: 123456789; display: none; color: var(--txt-color); background: rgba(0, 0, 0, 0.8); transition: 0.3s linear;">background:<input type="color" style="width: 40px;"><input type="range" min="0" max="255" step="1" style="display: inline-block; width: 200px;"><br><div style="display: flex; flex-wrap: wrap;"><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">vol all &gt;100%</button><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">vlm 0%~1000%</button><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">音量All</button><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">alert</button><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">clr</button><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">font-family</button><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">font-size</button><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">scan</button><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">180度旋轉</button><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">上下翻轉</button><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">左右翻轉</button><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">video截圖</button><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">full sc</button><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">img</button><button style="border: 1px solid black; height: 25px; font-size: 15px !important;">multi_img</button></div><input type="text" placeholder="YT video link" style="border: 1px solid black; font-size: 15px !important;"><iframe width="500" height="100" allowfullscreen="" frameborder="0" src=""></iframe></div>



<nav id="toc-container">
    <h4>目錄</h4>
    <ul id="toc-list"><li><a href="#h-0">事前準備</a></li><li><a href="#h-1">#01</a></li><li><a href="#h-2">#02</a></li></ul>
</nav>

<div class="main-content-wrapper">
    

    <header>
        <h1 id="m-name" style="color: var(--accent-color);">Venus</h1>
    </header>

    <main id="content">
        <h2 id="h-0">事前準備</h2><div>先在&nbsp;<a href="https://hackmyvm.eu/venus/" target="_blank">venus</a>&nbsp;可以找到我們接下來要訓練的靶機資訊</div><div><div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">Host: venus.hackmyvm.eu
Port: 5000
User: hacker
Pass: havefun!
</code></pre>
        </div><p>接下來輸入&nbsp;</p><p><div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">ssh hacker@venus.hackmyvm.eu -p 5000</code></pre>
        </div><p>然後在&nbsp;<span style="background-color: rgba(107, 107, 107, 0.6);">hacker@venus.hackmyvm.eu's password:</span></p><p><span style="background-color: rgba(107, 107, 107, 0.6);"><div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">havefun!</code></pre>
        </div><p><span style="background-color: rgb(31, 31, 31);">看到&nbsp;</span>hacker@venus:~$<span style="background-color: rgb(31, 31, 31);"> 就是成功了</span></p></span></p></p></div><div><p></p><h2 id="h-1">#01</h2><div>在這個端口下，我們得先掃描有什麼檔案</div><div><div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">ls -la</code></pre>
        </div><p>然後他會回傳</p><p><div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">total 40
drwxr-x--- 2 root   hacker 4096 Apr  5  2024 .
drwxr-xr-x 1 root   root   4096 Apr  5  2024 ..
-rw-r----- 1 root   hacker   31 Apr  5  2024 ...
-rw-r--r-- 1 hacker hacker  220 Apr 23  2023 .bash_logout
-rw-r--r-- 1 hacker hacker 3526 Apr 23  2023 .bashrc
-rw-r----- 1 root   hacker   16 Apr  5  2024 .myhiddenpazz
-rw-r--r-- 1 hacker hacker  807 Apr 23  2023 .profile
-rw-r----- 1 root   hacker  287 Apr  5  2024 mission.txt
-rw-r----- 1 root   hacker 2542 Apr  5  2024 readme.txt
</code></pre>
        </div><p>在 <span style="background-color: rgba(107, 107, 107, 0.6);">mission.txt</span> 可以看到 #001 的任務<div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">################
# MISSION 0x01 #
################

## EN ##
User sophia has saved her password in a hidden file in this folder. Find it and log in as sophia.

</code></pre>
        </div><p>在任務中可以明顯看到我們接下來的任務是要找到一個在其中的檔案</p><p><div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">cat .myhiddenpazz</code></pre>
        </div><p>就可以找到 sophia 的 password</p></p></p></p><p><div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">Y1o645M3mR84ejc</code></pre>
        </div><p>題外話，這裡有一個隱藏的 flag ( 他一定猜我們想不到這是一個檔案<div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">cat ...</code></pre>
        </div><p>可以看到</p><p><div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">8===skQEDuHXLkIUVlPqZqyE===D~~</code></pre>
        </div><p>&nbsp; &nbsp;&nbsp;<strike>這flag還挺有格調</strike></p></p></p></p><p>接下來要去登入sophia的帳號</p><p><div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">su sophia
</code></pre>
        </div><p>password 貼上即可</p></p><p>看到&nbsp;<span style="background-color: rgba(107, 107, 107, 0.6);">sophia@venus:/pwned/hacker$</span> 就代表登入成功了<br>接下來，我們要到 sophia 的個人資料夾裡面看看</p><p><div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">cd ../sophia</code></pre>
        </div><p>同樣步驟<div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">ls -la</code></pre>
        </div><p>看到</p></p></p><p><div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">total 32
drwxr-x--- 2 root   sophia 4096 Apr  5  2024 .
drwxr-xr-x 1 root   root   4096 Apr  5  2024 ..

-rw-r--r-- 1 sophia sophia  220 Apr 23  2023 .bash_logout
-rw-r--r-- 1 sophia sophia 3526 Apr 23  2023 .bashrc
-rw-r--r-- 1 sophia sophia  807 Apr 23  2023 .profile
-rw-r----- 1 root   sophia   31 Apr  5  2024 flagz.txt
-rw-r----- 1 root   sophia  359 Apr  5  2024 mission.txt

</code></pre>
        </div><p>打印</p></p><p><div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">cat flagz.txt</code></pre>
        </div><p>看到輸出<div class="code-container">
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            
            
            <div class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></div>
            <pre class="language-bash"><code class="language-bash" onpaste="handleCodePaste(event)">8===LUzzNuv8NB59iztWUIQS===D~~</code></pre>
        </div><p>就算本題完成了。</p></p></p><p>接下來的步驟都會類似，最後別忘了 flag 要去繳交&nbsp;<a href="https://hackmyvm.eu/venus/flagz.php" target="_blank">這裡這裡</a></p><h2 id="h-2">#02</h2><div><p><br></p></div></div><p></p><p></p></div>
    </main>
</div>




<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cplusplus.min.js"></script>

<script>
    let lastRange = null;
    const copySVG = `<svg viewBox="0 0 24 24" width="16" fill="#c1c1c1"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>`;
    const checkSVG = `<svg viewBox="0 0 24 24" width="16" fill="#766DF8"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`;

    document.addEventListener('selectionchange', () => {
        const sel = window.getSelection();
        if (sel.rangeCount > 0) {
            const range = sel.getRangeAt(0);
            if (document.getElementById('content').contains(range.commonAncestorContainer)) {
                lastRange = range.cloneRange();
            }
        }
    });

    function restoreSel() {
        if (lastRange) {
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(lastRange);
        }
    }

    function handleAction(e, cb) { e.preventDefault(); restoreSel(); cb(); updateTOC(); }
    const exec = (cmd, val = null) => { document.execCommand(cmd, false, val); updateTOC(); };

    function updateTOC() {
        const list = document.getElementById('toc-list');
        const hs = document.getElementById('content').querySelectorAll('h2, h3');
        list.innerHTML = "";
        hs.forEach((h, i) => {
            const id = "h-" + i;
            h.id = id;
            const li = document.createElement('li');
            if(h.tagName === 'H3') li.className = 'toc-h3';
            const a = document.createElement('a');
            a.href = "#" + id;
            a.innerText = h.innerText || "未命名標題";
            a.onclick = (e) => { e.preventDefault(); h.scrollIntoView({ behavior: 'smooth' }); };
            li.appendChild(a);
            list.appendChild(li);
        });
    }

    const obs = new MutationObserver(updateTOC);
    obs.observe(document.getElementById('content'), { childList: true, subtree: true, characterData: true });

    function openLinkModal() {
        document.getElementById('link-text').value = window.getSelection().toString();
        document.getElementById('link-url').value = "https://";
        document.getElementById('custom-modal').style.display = 'flex';
        document.getElementById('modal-confirm-btn').onclick = () => {
            const t = document.getElementById('link-text').value;
            const u = document.getElementById('link-url').value;
            restoreSel();
            exec('insertHTML', `<a href="${u}" target="_blank">${t || u}</a>`);
            closeModal();
        };
    }
    function closeModal() { document.getElementById('custom-modal').style.display = 'none'; }

    function insertNode(tag, txt) {
        const el = document.createElement(tag);
        el.innerText = txt;
        insertAtCursor(el);
    }

    function insertAtCursor(node) {
        restoreSel();
        const sel = window.getSelection();
        if (sel.rangeCount) {
            const range = sel.getRangeAt(0);
            range.insertNode(node);
            range.setStartAfter(node);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }

    function insertCode() {
        const container = document.createElement('div');
        container.className = 'code-container';
        container.setAttribute('contenteditable', 'false');
        
        container.innerHTML = `
            <div class="lang-badge" onclick="toggleLang(this, event)">bash</div>
            <div class="del-code-btn" onclick="toggleDelPop(this)">×</div>
            <div class="del-pop">
                <span>刪除？</span>
                <button onclick="this.closest('.code-container').remove()">是</button>
                <button onclick="this.parentElement.style.display='none'">否</button>
            </div>
            <div class="copy-btn" onclick="copyText(this)">${copySVG}</div>
            <pre class="language-bash"><code class="language-bash" contenteditable="true" onpaste="handleCodePaste(event)">code_here</code></pre>
        `;
        insertAtCursor(container);
        
        const p = document.createElement('p');
        p.innerHTML = '<br>';
        container.after(p);
        
        const sel = window.getSelection();
        const range = document.createRange();
        range.setStart(p, 0);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);
    }

    function toggleDelPop(btn) {
        const pop = btn.parentElement.querySelector('.del-pop');
        pop.style.display = (pop.style.display === 'flex' ? 'none' : 'flex');
    }

    function handleCodePaste(e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text');
        document.execCommand("insertText", false, text);
    }

    function toggleLang(badge, e) {
        e.stopPropagation();
        const ls = ['bash', 'python', 'php', 'javascript', 'cpp'];
        let cur = badge.innerText.toLowerCase();
        let next = ls[(ls.indexOf(cur === 'c++' ? 'cpp' : cur) + 1) % ls.length];
        badge.innerText = next === 'cpp' ? 'c++' : next;
        
        const pre = badge.parentElement.querySelector('pre');
        const code = badge.parentElement.querySelector('code');
        pre.className = 'language-' + next;
        code.className = 'language-' + next;
        Prism.highlightElement(code);
    }

    function copyText(btn) {
        const container = btn.closest('.code-container');
        const text = container.querySelector('code').innerText;
        navigator.clipboard.writeText(text).then(() => {
            btn.innerHTML = checkSVG; // 只更換按鈕內部的 SVG
            setTimeout(() => { btn.innerHTML = copySVG; }, 1500);
        });
    }

    function refreshHighlight() { Prism.highlightAll(); }

    function triggerImageUpload() { document.getElementById('img-input').click(); }
    document.getElementById('img-input').onchange = function(e) {
        const f = e.target.files[0];
        if (f) {
            const r = new FileReader();
            r.onload = (ev) => {
                const img = document.createElement('img');
                img.src = ev.target.result;
                img.className = 'inserted-img';
                img.onclick = function() { if(document.body.classList.contains('editing') && confirm("刪除圖片？")) this.remove(); };
                insertAtCursor(img);
            };
            r.readAsDataURL(f);
        }
    };

    function triggerImport() { document.getElementById('html-import').click(); }
    document.getElementById('html-import').onchange = function(e) {
        const f = e.target.files[0];
        const r = new FileReader();
        r.onload = (ev) => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(ev.target.result, 'text/html');
            const newC = doc.getElementById('content').innerHTML;
            const newN = doc.getElementById('m-name').innerText;
            if (newC) {
                const target = document.getElementById('content');
                target.innerHTML = newC;
                document.getElementById('m-name').innerText = newN;
                
                // 匯入後重新為 Code 框補上按鈕與刪除邏輯
                target.querySelectorAll('.code-container').forEach(cc => {
                    cc.setAttribute('contenteditable', 'false');
                    
                    // 如果沒有 X 鈕，補上
                    if(!cc.querySelector('.del-code-btn')) {
                        const x = document.createElement('div');
                        x.className = 'del-code-btn';
                        x.innerText = '×';
                        x.onclick = function() { toggleDelPop(this); };
                        cc.prepend(x);
                    } else {
                        // 如果有 X 鈕，重新綁定點擊事件
                        cc.querySelector('.del-code-btn').onclick = function() { toggleDelPop(this); };
                    }
                    
                    // 如果沒有刪除彈窗，補上
                    if(!cc.querySelector('.del-pop')) {
                        const pop = document.createElement('div');
                        pop.className = 'del-pop';
                        pop.innerHTML = `<span>刪除？</span><button onclick="this.closest('.code-container').remove()">是</button><button onclick="this.parentElement.style.display='none'">否</button>`;
                        cc.appendChild(pop);
                    }
                });

                refreshHighlight();
                updateTOC();
            }
        };
        r.readAsText(f);
    };

    function exportHTML() {
        updateTOC();
        const clone = document.documentElement.cloneNode(true);
        const body = clone.querySelector('body');
        body.classList.remove('editing');
        
        ['#toolbar', '#img-input', '#html-import', '#custom-modal', '.del-code-btn', '.del-pop'].forEach(s => {
            clone.querySelectorAll(s).forEach(el => el.remove());
        });
        
        clone.querySelectorAll('[contenteditable]').forEach(el => el.removeAttribute('contenteditable'));
        
        const script = document.createElement('script');
        script.innerText = `
            document.querySelectorAll('#toc-list a').forEach(a => {
                a.onclick = (e) => {
                    e.preventDefault();
                    const t = document.querySelector(a.getAttribute('href'));
                    if(t) t.scrollIntoView({behavior:'smooth'});
                }
            });
            const checkSVG = \`${checkSVG}\`;
            const copySVG = \`${copySVG}\`;
            function copyText(btn) {
                const container = btn.closest('.code-container');
                const text = container.querySelector('code').innerText;
                navigator.clipboard.writeText(text).then(() => {
                    btn.innerHTML = checkSVG;
                    setTimeout(() => { btn.innerHTML = copySVG; }, 1500);
                });
            }
        `;
        body.appendChild(script);
        
        const blob = new Blob(["<!DOCTYPE html>\n" + clone.outerHTML], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Writeup_${Date.now()}.html`;
        a.click();
    }

    updateTOC();
</script>
