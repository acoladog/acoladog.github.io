<!DOCTYPE html>
<html>
<head>
	<style>
	     body {
	       background-color: antiquewhite;
	       margin: 0;
	       padding: 0;
	       overflow-x: auto;
	       overflow-y: auto;
	     }
	     body::-webkit-scrollbar {
	       display: none;
	     }

	     /* ç™½æ¿å®¹å™¨ */
	     .whiteboard-container {
	       position: relative;
	       width: 94%;
	       margin: auto;
	       padding: 30px 0;
	     }

	     #whiteboard {
	       background-color: white;
	       display: block;
	       width: 100%;
	       cursor: crosshair;
	       border: 1px solid #ccc;
	       box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	       touch-action: none; /* é˜²æ­¢é è¨­è§¸æ§è¡Œç‚º */
	     }

	     /* å´æ¬„ */
        #sidebar {
          position: fixed;
          top: 50px;
          left: 4%;
          width: 60px;
          background: rgba(255, 209, 191, 0.8);
          color: white;
          display: flex;
          flex-direction: column;
          gap: 10px;
          padding: 10px;
          border-radius: 10px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
          z-index: 1000;
        }

	     #sidebar button {
	       background: white;
	       border: none;
	       padding: 8px;
	       border-radius: 6px;
	       cursor: pointer;
	       transition: background 0.2s;
	     }

	     #sidebar button:hover {
	       background: lightgray;
	     }

	     #sidebar button.active {
	       background: #ffd1bf;
	     }

       .hidden{
        display: none !important;
       }

       /* ç­†åˆ·è¨­ç½®é¢æ¿ */
       #brush-settings {
        position: fixed;
        top: 20px;
        left: 12%;
        background: rgb(255 201 201 / 95%);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        min-width: 280px;
        border: 1px solid #ccc;
      }

      #brush-settings label {
        display: block;
        margin-bottom: 15px;
        font-size: 14px;
        color: #333;
        font-weight: 500;
      }

      #brush-settings input[type="color"] {
        width: 50px;
        height: 30px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
      }

      .size-control {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 5px;
      }

      #brush-settings input[type="range"] {
        flex: 1;
        cursor: pointer;
      }

      .size-display {
        font-weight: bold;
        color: #666;
        min-width: 40px;
      }

      .size-preview {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
      }

      .size-circle {
        background-color: #333;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      /* å·¥å…·è¨­å®šåˆ†çµ„ */
      .tool-section {
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        background: #ffb0b0;
      }

      .tool-section:last-child {
        margin-bottom: 0;
      }

      .tool-section h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #555;
        font-weight: 600;
      }

      /* é é¢æ§åˆ¶é¢æ¿ */
      #page-controls {
        position: fixed;
        top: 88%;
        right: 2%;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        display: flex;
        align-items: center;
        gap: 10px;
        border: 1px solid #ccc;
      }

      #page-controls button {
        background: #f0f0f0;
        border: 1px solid #ccc;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      #page-controls button:hover {
        background: #e0e0e0;
      }

      #page-controls button:disabled {
        background: #f8f8f8;
        color: #ccc;
        cursor: not-allowed;
      }

      #page-info {
        font-size: 14px;
        color: #333;
        font-weight: 500;
        min-width: 80px;
        text-align: center;
      }

      /* æ©¡çš®æ“¦æ¸¸æ¨™æŒ‡ç¤º */
      #eraser-cursor {
        position: fixed;
        border: 2px solid #666;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.3);
        pointer-events: none;
        z-index: 1002;
        display: none;
      }

      /* æ‰‹æŒæ¨¡å¼æŒ‡ç¤ºå™¨ */
      #palm-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255, 165, 0, 0.9);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        z-index: 1003;
        display: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

	</style>
	<title>Canvasç™½æ¿ - æ”¯æ´æ‰‹æŒæ©¡çš®æ“¦</title>
</head>
<body>
  <!-- ç­†åˆ·è¨­ç½®é¢æ¿ -->
  <div id="brush-settings" class="hidden">
    <!-- ç­†åˆ·è¨­å®š -->
    <div id="brush-section" class="tool-section">
      <h3>ç­†åˆ·è¨­å®š</h3>
      <label>
        é¡è‰²: <input type="color" id="brush-color" value="#000000">
      </label>
      <label>
        ç­†åˆ·ç²—ç´°: <span class="size-display" id="brush-size-display">5px</span>
        <div class="size-control">
          <input type="range" id="brush-size" min="1" max="50" value="10">
          <div class="size-preview">
            <div class="size-circle" id="brush-size-circle"></div>
          </div>
        </div>
      </label>
    </div>

    <!-- æ©¡çš®æ“¦è¨­å®š -->
    <div id="eraser-section" class="tool-section">
      <h3>æ©¡çš®æ“¦è¨­å®š</h3>
      <label>
        æ©¡çš®æ“¦ç²—ç´°: <span class="size-display" id="eraser-size-display">15px</span>
        <div class="size-control">
          <input type="range" id="eraser-size" min="5" max="300" value="50">
          <div class="size-preview">
            <div class="size-circle" id="eraser-size-circle"></div>
          </div>
        </div>
      </label>
    </div>
  </div>

  <!-- æ©¡çš®æ“¦æ¸¸æ¨™æŒ‡ç¤º -->
  <div id="eraser-cursor"></div>

  <!-- æ‰‹æŒæ¨¡å¼æŒ‡ç¤ºå™¨ -->
  <div id="palm-indicator">ğŸ–ï¸ æ‰‹æŒæ©¡çš®æ“¦æ¨¡å¼</div>

  <!-- é é¢æ§åˆ¶é¢æ¿ -->
  <div id="page-controls">
    <button id="prev-page">â—€</button>
    <span id="page-info">ç¬¬ 1 é </span>
    <button id="next-page">â–¶</button>
  </div>

	<div class="whiteboard-container">
		<canvas id="whiteboard"></canvas>
		<!-- å´æ¬„ -->
		<div id="sidebar" class="hidden">
			<!-- ç­†åˆ· -->
			<button id="brush-btn" title="ç­†åˆ·">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25ZM20.71 7.04C21.1 6.65 21.1 6.02 20.71 5.63L18.37 3.29C17.98 2.9 17.35 2.9 16.96 3.29L15.13 5.12L18.88 8.87L20.71 7.04Z" fill="currentColor"/>
        </svg>
      </button>
      
      <!-- æ©¡çš®æ“¦ -->
      <button id="eraser-btn" title="æ©¡çš®æ“¦">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M5 15L15 5L21 11L11 21H5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M13 7L19 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M8 12V18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M14 18H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <!-- æ¸…é™¤ç•«é¢ -->
      <button id="clear-btn" title="æ¸…é™¤ç•¶å‰é é¢">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 19C6 20.1 6.9 21 8 21H16C17.1 21 18 20.1 18 19V7H6V19ZM19 4H15.5L14.5 3H9.5L8.5 4H5V6H19V4Z" fill="currentColor"/>
        </svg>
      </button>
		</div>
	</div>
  
  <script>
    const canvas = document.getElementById("whiteboard");
    const sidebar = document.getElementById("sidebar");
    const ctx = canvas.getContext("2d");
    const brushBtn = document.getElementById("brush-btn");
    const eraserBtn = document.getElementById("eraser-btn");
    const clearBtn = document.getElementById("clear-btn");
    const brushSettings = document.getElementById("brush-settings");
    const brushSection = document.getElementById("brush-section");
    const eraserSection = document.getElementById("eraser-section");
    const brushColorInput = document.getElementById("brush-color");
    const brushSizeInput = document.getElementById("brush-size");
    const eraserSizeInput = document.getElementById("eraser-size");
    const brushSizeDisplay = document.getElementById("brush-size-display");
    const eraserSizeDisplay = document.getElementById("eraser-size-display");
    const brushSizeCircle = document.getElementById("brush-size-circle");
    const eraserSizeCircle = document.getElementById("eraser-size-circle");
    const pageControls = document.getElementById("page-controls");
    const prevPageBtn = document.getElementById("prev-page");
    const nextPageBtn = document.getElementById("next-page");
    const pageInfo = document.getElementById("page-info");
    const eraserCursor = document.getElementById("eraser-cursor");
    const palmIndicator = document.getElementById("palm-indicator");

    let drawing = false;
    let currentTool = "none"; // "brush", "eraser", "none"
    let originalTool = "brush"; // è¨˜éŒ„æ‰‹æŒè§¸æ§å‰çš„åŸå§‹å·¥å…·
    let brushColor = "#000000";
    let brushSize = 5;
    let eraserSize = 15;
    let currentPage = 1;
    let totalPages = 1;
    let pageData = {}; // å„²å­˜æ¯é çš„ç•«å¸ƒæ•¸æ“š
    let lastPoint = null; // ä¸Šä¸€å€‹ç¹ªç•«é»ï¼Œç”¨æ–¼æ›´ç´°å¯†çš„ç­†è§¸
    let isPalmMode = false; // æ˜¯å¦ç‚ºæ‰‹æŒæ¨¡å¼
    let palmModeTimeout = null; // æ‰‹æŒæ¨¡å¼è¶…æ™‚

    // æ›´æ–°å°ºå¯¸é è¦½åœ“åœˆ
    function updateSizePreview() {
      // æ›´æ–°ç­†åˆ·é è¦½
      const brushPreviewSize = Math.min(Math.max(brushSize, 2), 30);
      brushSizeCircle.style.width = brushPreviewSize + 'px';
      brushSizeCircle.style.height = brushPreviewSize + 'px';
      brushSizeCircle.style.backgroundColor = brushColor;
      brushSizeDisplay.textContent = brushSize + 'px';
      
      // æ›´æ–°æ©¡çš®æ“¦é è¦½
      const eraserPreviewSize = Math.min(Math.max(eraserSize / 2, 5), 30);
      eraserSizeCircle.style.width = eraserPreviewSize + 'px';
      eraserSizeCircle.style.height = eraserPreviewSize + 'px';
      eraserSizeCircle.style.backgroundColor = '#ccc';
      eraserSizeDisplay.textContent = eraserSize + 'px';
    }

    // é¡¯ç¤ºå°æ‡‰å·¥å…·çš„è¨­å®šå€å¡Š
    function showToolSettings(tool) {
      if (tool === "brush") {
        brushSection.style.display = "block";
        eraserSection.style.display = "none";
      } else if (tool === "eraser") {
        brushSection.style.display = "none";
        eraserSection.style.display = "block";
      } else {
        brushSection.style.display = "block";
        eraserSection.style.display = "block";
      }
    }

    // è¨­ç½®canvaså°ºå¯¸ï¼ˆæœ‰åº•é‚Šç•Œï¼‰
    function setupCanvas() {
      const container = canvas.parentElement;
      const containerWidth = container.clientWidth;
      const containerHeight = Math.max(window.innerHeight - 100, 600); // æœ‰åº•é‚Šç•Œ
      
      // è¨­ç½®canvasçš„å¯¦éš›å°ºå¯¸
      canvas.width = containerWidth;
      canvas.height = containerHeight;
      
      // è¨­ç½®canvasçš„é¡¯ç¤ºå°ºå¯¸ï¼ˆCSSï¼‰
      canvas.style.width = containerWidth + 'px';
      canvas.style.height = containerHeight + 'px';
      
      // è¨­ç½®ç¹ªåœ–ä¸Šä¸‹æ–‡çš„åˆå§‹ç‹€æ…‹
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      // å•Ÿç”¨æŠ—é‹¸é½’ï¼Œè®“ç·šæ¢æ›´å¹³æ»‘
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
    }

    // åˆå§‹åŒ–canvas
    setupCanvas();
    
    // åˆå§‹åŒ–ç¬¬ä¸€é æ•¸æ“š
    saveCurrentPageData();

    // çª—å£å¤§å°æ”¹è®Šæ™‚é‡æ–°è¨­ç½®canvas
    window.addEventListener('resize', () => {
      saveCurrentPageData(); // ä¿å­˜ç•¶å‰é é¢
      setupCanvas();
      loadCurrentPageData(); // é‡æ–°è¼‰å…¥ç•¶å‰é é¢
    });

    // ç²å–æº–ç¢ºçš„æ»‘é¼ åº§æ¨™
    function getMousePos(e) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: (e.clientX - rect.left) * (canvas.width / rect.width),
        y: (e.clientY - rect.top) * (canvas.height / rect.height)
      };
    }

    // ç²å–è§¸æ§é»åº§æ¨™
    function getTouchPos(touch) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: (touch.clientX - rect.left) * (canvas.width / rect.width),
        y: (touch.clientY - rect.top) * (canvas.height / rect.height)
      };
    }

    // è¨ˆç®—å…©é»é–“è·é›¢
    function distance(point1, point2) {
      return Math.sqrt(
        Math.pow(point2.x - point1.x, 2) + Math.pow(point2.y - point1.y, 2)
      );
    }

    // ç´°å¯†ç¹ªç•« - åœ¨å…©é»é–“æ’å…¥ä¸­é–“é»
    function drawSmoothLine(from, to) {
      const dist = distance(from, to);
      const steps = Math.max(1, Math.floor(dist / 2)); // æ¯2åƒç´ ä¸€å€‹é»
      
      for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        const x = from.x + (to.x - from.x) * t;
        const y = from.y + (to.y - from.y) * t;
        
        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(x, y, ctx.lineWidth / 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(x, y);
      }
    }

    // ä¿å­˜ç•¶å‰é é¢æ•¸æ“š
    function saveCurrentPageData() {
      pageData[currentPage] = canvas.toDataURL();
    }

    // è¼‰å…¥é é¢æ•¸æ“š
    function loadCurrentPageData() {
      const img = new Image();
      img.onload = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
      };
      img.src = pageData[currentPage] || '';
      
      if (!pageData[currentPage]) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }

    // æ›´æ–°é é¢é¡¯ç¤º
    function updatePageDisplay() {
      pageInfo.textContent = `ç¬¬ ${currentPage} é `;
      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = false;
    }

    // æª¢æ¸¬æ‰‹æŒè§¸æ§ï¼ˆåŸºæ–¼è§¸æ§å€åŸŸå¤§å°ï¼‰
    function isPalmTouch(touch) {
      // æª¢æŸ¥è§¸æ§å€åŸŸåŠå¾‘ï¼Œæ‰‹æŒé€šå¸¸æœ‰è¼ƒå¤§çš„æ¥è§¸é¢ç©
      const radiusX = touch.radiusX || 0;
      const radiusY = touch.radiusY || 0;
      const avgRadius = (radiusX + radiusY) / 2;
      
      // å¦‚æœè§¸æ§å€åŸŸåŠå¾‘å¤§æ–¼15åƒç´ ï¼Œèªç‚ºæ˜¯æ‰‹æŒ
      return avgRadius > 15;
    }

    // å•Ÿç”¨æ‰‹æŒæ¨¡å¼
    function enablePalmMode() {
      if (!isPalmMode) {
        originalTool = currentTool;
        isPalmMode = true;
        selectTool("eraser");
        palmIndicator.style.display = "block";
      }
      
      // æ¸…é™¤ä¹‹å‰çš„è¶…æ™‚
      if (palmModeTimeout) {
        clearTimeout(palmModeTimeout);
      }
    }

    // åœç”¨æ‰‹æŒæ¨¡å¼
    function disablePalmMode() {
      if (isPalmMode) {
        isPalmMode = false;
        selectTool(originalTool);
        palmIndicator.style.display = "none";
      }
      
      if (palmModeTimeout) {
        clearTimeout(palmModeTimeout);
        palmModeTimeout = null;
      }
    }

    // å»¶é²åœç”¨æ‰‹æŒæ¨¡å¼
    function scheduleDisablePalmMode() {
      if (palmModeTimeout) {
        clearTimeout(palmModeTimeout);
      }
      
      // 500mså¾Œåœç”¨æ‰‹æŒæ¨¡å¼
      palmModeTimeout = setTimeout(() => {
        disablePalmMode();
      }, 100);
    }

    // é—œé–‰æ‰€æœ‰å´æ¬„
    function closeAllSidebars() {
      sidebar.classList.add("hidden");
      brushSettings.classList.add("hidden");
    }

    // å´æ¬„åˆ‡æ›é‚è¼¯ï¼ˆä¿®æ”¹ç‚ºé»æ“Šcanvaså¤–çš„å€åŸŸï¼‰
    document.body.addEventListener("click", function(e) {
        // å¦‚æœé»æ“Šçš„æ˜¯canvasï¼Œé—œé–‰æ‰€æœ‰å´æ¬„
        if (e.target === canvas) {
            closeAllSidebars();
            return;
        }
        
        // å¦‚æœé»æ“Šçš„ä¸æ˜¯å´æ¬„æˆ–è¨­å®šé¢æ¿å…§çš„å…ƒç´  
        if (!sidebar.contains(e.target) && !brushSettings.contains(e.target) && !pageControls.contains(e.target) && e.target !== canvas) {
            const clickLeft = e.clientX < window.innerWidth / 2;
            const sidebarOnLeft = sidebar.style.left !== "auto" && sidebar.style.left !== "";

            if ((clickLeft && sidebarOnLeft) || (!clickLeft && !sidebarOnLeft)) {
                sidebar.classList.toggle("hidden");
                if (sidebar.classList.contains("hidden")) {
                    brushSettings.classList.add("hidden");
                }
            } else {
                if (clickLeft) {
                    sidebar.style.left = "4%";
                    sidebar.style.right = "auto";
                    brushSettings.style.left = "12%";
                    brushSettings.style.right = "auto";
                } else {
                    sidebar.style.right = "4%";
                    sidebar.style.left = "auto";
                    brushSettings.style.right = "12%";
                    brushSettings.style.left = "auto";
                }
                sidebar.classList.remove("hidden");
            }
        }
    });

    // å·¥å…·é¸æ“‡é‚è¼¯
    function selectTool(tool) {
      // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„activeç‹€æ…‹
      document.querySelectorAll('#sidebar button').forEach(btn => btn.classList.remove('active'));
      
      currentTool = tool;
      
      if (tool === "brush") {
        brushBtn.classList.add('active');
        canvas.style.cursor = "crosshair";
        eraserCursor.style.display = "none";
      } else if (tool === "eraser") {
        eraserBtn.classList.add('active');
        canvas.style.cursor = "none";
        eraserCursor.style.display = "block";
        updateEraserCursor();
      } else {
        canvas.style.cursor = "default";
        eraserCursor.style.display = "none";
      }
      updateSizePreview();
    }

    // æ›´æ–°æ©¡çš®æ“¦æ¸¸æ¨™
    function updateEraserCursor() {
      if (currentTool === "eraser") {
        eraserCursor.style.width = eraserSize + 'px';
        eraserCursor.style.height = eraserSize + 'px';
      }
    }

    // ç­†åˆ·æŒ‰éˆ•
    brushBtn.addEventListener("click", () => {
        if (currentTool !== "brush") {
            selectTool("brush");
            brushSettings.classList.add("hidden"); // åˆ‡æ›å·¥å…·æ™‚éš±è—è¨­å®šé¢æ¿
        } else {
            brushSettings.classList.toggle("hidden");
            if (!brushSettings.classList.contains("hidden")) {
                showToolSettings("brush");
            }
        }
    });

    // æ©¡çš®æ“¦æŒ‰éˆ•
    eraserBtn.addEventListener("click", () => {
        if (currentTool !== "eraser") {
            selectTool("eraser");
            brushSettings.classList.add("hidden"); // åˆ‡æ›å·¥å…·æ™‚éš±è—è¨­å®šé¢æ¿
        } else {
            brushSettings.classList.toggle("hidden");
            if (!brushSettings.classList.contains("hidden")) {
                showToolSettings("eraser");
            }
        }
    });

    // æ¸…é™¤æŒ‰éˆ• - åªæ¸…é™¤ç•¶å‰é é¢
    clearBtn.addEventListener("click", () => {
        if (confirm("ç¢ºå®šè¦æ¸…é™¤ç•¶å‰é é¢å—ï¼Ÿ")) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            pageData[currentPage] = '';
        }
    });

    // é é¢æ§åˆ¶
    prevPageBtn.addEventListener("click", () => {
        if (currentPage > 1) {
            saveCurrentPageData();
            currentPage--;
            loadCurrentPageData();
            updatePageDisplay();
        }
    });

    nextPageBtn.addEventListener("click", () => {
        saveCurrentPageData();
        currentPage++;
        if (currentPage > totalPages) {
            totalPages = currentPage;
        }
        loadCurrentPageData();
        updatePageDisplay();
    });

    // æ›´æ–°ç­†åˆ·è¨­ç½®
    brushColorInput.addEventListener("input", (e) => {
        brushColor = e.target.value;
        updateSizePreview();
    });
    
    brushSizeInput.addEventListener("input", (e) => {
        brushSize = parseInt(e.target.value);
        updateSizePreview();
    });

    eraserSizeInput.addEventListener("input", (e) => {
        eraserSize = parseInt(e.target.value);
        updateSizePreview();
        updateEraserCursor();
    });

    // æ»‘é¼ ç¹ªåœ–äº‹ä»¶
    canvas.addEventListener("mousedown", (e) => {
        if (currentTool === "none") return;
        
        drawing = true;
        const pos = getMousePos(e);
        lastPoint = pos;
        
        if (currentTool === "brush") {
            ctx.globalCompositeOperation = "source-over";
            ctx.strokeStyle = brushColor;
            ctx.fillStyle = brushColor;
            ctx.lineWidth = brushSize;
        } else if (currentTool === "eraser") {
            ctx.globalCompositeOperation = "destination-out";
            ctx.lineWidth = eraserSize;
        }
        
        // ç•«ä¸€å€‹é»ï¼ˆè™•ç†å–®é»é»æ“Šï¼‰
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, ctx.lineWidth / 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
    });

    canvas.addEventListener("mousemove", (e) => {
        // æ›´æ–°æ©¡çš®æ“¦æ¸¸æ¨™ä½ç½®
        if (currentTool === "eraser") {
            const rect = canvas.getBoundingClientRect();
            eraserCursor.style.left = (e.clientX - eraserSize / 2) + 'px';
            eraserCursor.style.top = (e.clientY - eraserSize / 2) + 'px';
        }
        
        if (!drawing || currentTool === "none") return;
        
        const pos = getMousePos(e);
        
        if (lastPoint) {
            // ä½¿ç”¨ç´°å¯†ç¹ªç•«æ–¹æ³•
            drawSmoothLine(lastPoint, pos);
        }
        
        lastPoint = pos;
    });

    canvas.addEventListener("mouseup", () => {
        if (drawing) {
            drawing = false;
            lastPoint = null;
            ctx.closePath();
        }
    });

    canvas.addEventListener("mouseenter", (e) => {
        if (currentTool === "eraser") {
            eraserCursor.style.display = "block";
        }
    });

    canvas.addEventListener("mouseleave", () => {
        if (currentTool === "eraser") {
            eraserCursor.style.display = "none";
        }
        
        if (drawing) {
            drawing = false;
            lastPoint = null;
            ctx.closePath();
        }
    });

    // è§¸æ§è¨­å‚™æ”¯æ´
    canvas.addEventListener("touchstart", (e) => {
        e.preventDefault();
        
        // æª¢æŸ¥æ˜¯å¦æœ‰å¤šå€‹è§¸æ§é»æˆ–å¤§é¢ç©è§¸æ§ï¼ˆæ‰‹æŒï¼‰
        if (e.touches.length > 1) {
            // å¤šé»è§¸æ§ï¼Œå•Ÿç”¨æ‰‹æŒæ¨¡å¼
            enablePalmMode();
            return;
        }
        
        const touch = e.touches[0];
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹æŒè§¸æ§
        if (isPalmTouch(touch)) {
            enablePalmMode();
        }
        
        if (currentTool === "none") return;
        
        const mouseEvent = new MouseEvent("mousedown", {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    });

    canvas.addEventListener("touchmove", (e) => {
        e.preventDefault();
        
        if (!drawing || currentTool === "none") return;
        
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent("mousemove", {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    });

    canvas.addEventListener("touchend", (e) => {
        e.preventDefault();
        
        // å¦‚æœæ²’æœ‰æ›´å¤šè§¸æ§é»ï¼Œå®‰æ’åœç”¨æ‰‹æŒæ¨¡å¼
        if (e.touches.length === 0) {
            scheduleDisablePalmMode();
        }
        
        const mouseEvent = new MouseEvent("mouseup", {});
        canvas.dispatchEvent(mouseEvent);
    });

    // ç›£è½è§¸æ§å–æ¶ˆäº‹ä»¶
    canvas.addEventListener("touchcancel", (e) => {
        e.preventDefault();
        scheduleDisablePalmMode();
        
        const mouseEvent = new MouseEvent("mouseup", {});
        canvas.dispatchEvent(mouseEvent);
    });

    // åˆå§‹åŒ–é é¢é¡¯ç¤º
    updatePageDisplay();
    
    // é è¨­é¸æ“‡ç­†åˆ·å·¥å…·
    selectTool("brush");
    updateSizePreview();
  </script>
</body>
</html>
